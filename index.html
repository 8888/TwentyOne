<html>
<head><title>Twenty One</title></head>
<body bgcolor="#24AF69">
	<canvas id="canvasElement" width="720" height="720" style="background-color: #F0F8FF;"></canvas>
	<script type="text/javascript">
		'use strict';
		var canvas = document.getElementById("canvasElement");
		canvas.tabIndex = 0;
		canvas.focus();

		var canvas_width = canvas.width;
		var canvas_height = canvas.height;
		var canvas_bounds = canvas.getBoundingClientRect();
		var ctx = canvas.getContext("2d");

        var mouseX = null,
            mouseY = null;

		var State = null; // object with different possible game states
		var Game = null; // Object that handles object interactions
		var human_player = null;
		var dealer_player = null;
		var players = []; // Array of all players in the game

		// Game initialization
		function init() {
			class GameState {
				// State of the game
				constructor() {
					this.new_game = 0b00000001;
					this.playing_hand = 0b00000010;
					this.dealer_playing = 0b00000100;
					this.hand_complete = 0b00001000;
				}
			}

			class Card {
				constructor(rank, value, suit) {
					this.rank = rank;
					this.value = value;
					this.suit = suit;
				}
			}

			class Player {
				constructor(is_dealer) {
					this.hand = [];
					this.hand_total = 0;
					this.is_dealer = is_dealer;
				}

				receive_card(card) {
					// add a card to the hand
					this.hand.push(card);
					this.calculate_total();
				}

				muck_hand() {
					// remove all cards from the hand
					this.hand_total = 0;
					return this.hand.splice(0, this.hand.length);
				}

				calculate_total() {
					// calculates the total hand value
					var total = 0;
					var ace_seen = [];
					if (this.hand.length > 0) {
						for (var c = 0; c < this.hand.length; c++) {
							if (this.hand[c].rank === "A") {
								total += this.hand[c].value[1]; // high
								ace_seen.push(10);
							} else {
								total += this.hand[c].value;
							}
						}
						if (total > 21 && ace_seen.length > 0) {
							for (var a = 0; a < ace_seen.length; a++) {
								total -= ace_seen[a];
								if (total <= 21) {
									a = ace_seen.length;
								}
							}

						}
					}
					this.hand_total = total;
				}
			}

			var game_singleton = (function() {
				// Creates one and only one instance of the game logic object
				var instance;
				function createInstance() {
					let game = {
						// Game parameters
						state: 0, // current game state
						deck: null,
						muck: [], // discard pile
						deckMin: 17, // minimum deck array length before reshuffling TODO: randomize this with each new shuffle
						message: ""
					}

					// Game functions
					game.make_deck = function(decks = 1) {
						// Creates a usable deck of cards, comprised of a user chosen amount of standard 52 card decks
						var card_ranks = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
						var card_values = [2,3,4,5,6,7,8,9,10,10,10,10,[1,11]];
						var card_suits = ["Clubs", "Diamonds", "Hearts", "Spades"];
						var new_deck = [];
						for (var i = 0; i < decks; i++) { // Number of decks requested
							for (var r = 0; r < card_ranks.length; r++) { // Each rank of cards
								for (var s = 0; s < card_suits.length; s++) { // 1 card for each of the four suits
									new_deck.push(new Card(card_ranks[r], card_values[r], card_suits[s]));
								}
							}
						}
						return new_deck;
					}

					game.rng = function(min, max) {
						// Returns a random integer between min(inclusive) and max(exclusive)
						return Math.floor(Math.random() * (max - min)) + min;
					}

					game.shuffle = function(unshuffled_deck, iterations = 10) {
						// Takes an array of Card objects and returns it in a random order
						var unshuffled_deck = unshuffled_deck;
						var shuffled_deck = [];
						for (var i = 0; i < iterations; i++) {
							for (var c = 0; c < unshuffled_deck.length;) {
								var index = this.rng(0, unshuffled_deck.length);
								var card = unshuffled_deck.splice(index, 1);
								shuffled_deck.push(card[0]);
							}
						}
						return shuffled_deck;
					}

					game.deal = function(player) {
						// Deals the last card in the deck array to the player
						let card = this.deck.pop();
						player.receive_card(card);
					}

					game.muck_hands = function(player) {
						// Moves all of the cards from the player's hands to the muck pile
						var mucked_hand = player.muck_hand();
							for (var c = 0; c < mucked_hand.length;) {
								let card = mucked_hand.pop();
								this.muck.push(card);
							}
					}

					game.new_hand = function(players) {
						// Starts a new hand
						for (var c = 0; c < 2; c++){ // 2 cards total per player
							for (var p = 0; p < players.length; p++) { // alternates to each player
								this.deal(players[p]);
							}
						}
					}

					game.deck_reshuffle = function() {
						// Reshuffles the cards from the muck and the deck into a new deck
						for (var c = 0; c < this.muck.length;) {
							let card = this.muck.pop();
							this.deck.push(card);
						}
						this.deck = this.shuffle(this.deck);
					}
					return game;
				}
				return {
					getInstance: function() {
						if (!instance) {
							instance = createInstance();
						}
						return instance;
					}
 				}
			})();
			
			State = new GameState();
			Game = game_singleton.getInstance();
			Game.state = State.new_game;
			human_player = new Player(false);
			dealer_player = new Player(true);
			players.push(human_player, dealer_player);
			Game.deck = Game.make_deck();
			Game.deck = Game.shuffle(Game.deck);
		}

		//Handle User Input
		canvas.addEventListener("mousedown", function(event) {
			mouseX = event.clientX - canvas_bounds.left;
			mouseY = event.clientY - canvas_bounds.top;

			// Click deal button
			if (Game.state === State.hand_complete) {
				if (mouseX > canvas_bounds.left+50 && mouseX < canvas_bounds.left+50+100) { // the buttons being clicked should have callable sizes, not hard coded all over the place. Variable? Object?
					if (mouseY > canvas_bounds.bottom-100 && mouseY < canvas_bounds.bottom-100+50) {
						for (var p = 0; p < players.length; p ++) { 
							if (players[p].hand) { // If the player has cards, discard them before dealing a new hand
								Game.muck_hands(players[p]);
							}
						}
						Game.new_hand(players);
						Game.state = State.playing_hand;
					}
				}
			}

			// Click Hit or Stand buttons
			if (Game.state === State.playing_hand) {
				// Hit
				if (mouseX > canvas_bounds.left+550 && mouseX < canvas_bounds.left+550+100) {
					if (mouseY > canvas_bounds.bottom-175 && mouseY < canvas_bounds.bottom-175+50) {
						Game.deal(human_player);
					}
				}
				// Stand
				if (mouseX > canvas_bounds.left+550 && mouseX < canvas_bounds.left+550+100) {
					if (mouseY > canvas_bounds.bottom-100 && mouseY < canvas_bounds.bottom-100+50) {
						Game.state = State.dealer_playing;
					}
				}
			}
		});

		canvas.addEventListener("mousemove", function(event) {
			mouseX = event.clientX - canvas_bounds.left;
			mouseY = event.clientY - canvas_bounds.top;
		});

		// Update
		var gameDelta = null,
            frameCount = 0;
		function update(delta) {
			gameDelta = delta;
            frameCount++;

			// New game
			if (Game.state === State.new_game) {
				Game.new_hand(players);
				Game.state = State.playing_hand;
			}
			// Playing hand
			if (Game.state === State.playing_hand) {
				Game.message = "Your move...";
				// Check for blackjack
				if (human_player.hand.length === 2 && dealer_player.hand.length === 2) {
					if (human_player.hand_total === 21) {
						if (dealer_player.hand_total === 21) {
							Game.message = "Push";
							Game.state = State.hand_complete;
						} else {
							Game.message = "You got a blackjack!";
							Game.state = State.hand_complete;
						}
					} else if (dealer_player.hand_total === 21) {
						Game.message = "The dealer got a blackjack!";
						Game.state = State.hand_complete;
					}
				}
				// Check for bust
				if (human_player.hand_total > 21) {
					Game.message = "You busted!";
					Game.state = State.hand_complete;
				}
			}
			// Dealer playing hand
			if (Game.state === State.dealer_playing) {
				// Check for bust
				if (dealer_player.hand_total > 21) {
					Game.message = "The dealer busted!";
					Game.state = State.hand_complete;
				} else if (dealer_player.hand_total < 17) {
					Game.deal(dealer_player);
				} else {
					if (human_player.hand_total > dealer_player.hand_total) {
						Game.message = "You win!";
					} else if (dealer_player.hand_total > human_player.hand_total) {
						Game.message = "You lose!";
					} else {
						Game.message = "push";
					}
					Game.state = State.hand_complete;
				}
			}


			// Hand complete
			if (Game.state === State.hand_complete) {
				// pay winnings, prepare for next hand, etc.
				if (Game.deck.length < Game.deckMin) {
					Game.deck_reshuffle();
					Game.message += " Deck shuffled!";
				}
			}
		}

		// Draw the elements to the canvas
		function display() {
			ctx.clearRect(0, 0, canvas_width, canvas_height);
            ctx.font = "14px Courier New";
            ctx.strokeStyle = "black";

			// Draw initial basic interface
			// ****This will change as the game expands****

			// Draw Table
			ctx.moveTo(canvas_bounds.left + canvas_width*.1, canvas_bounds.top + canvas_height*.4);
			ctx.lineTo(canvas_bounds.left + canvas_width*.1, canvas_bounds.top + canvas_height*.2);
			ctx.lineTo(canvas_bounds.left + canvas_width*.9, canvas_bounds.top + canvas_height*.2);
			ctx.lineTo(canvas_bounds.left + canvas_width*.9, canvas_bounds.top + canvas_height*.4);
			ctx.stroke();
			ctx.beginPath();
			ctx.arc(canvas_bounds.left + canvas_width*.5, canvas_bounds.top + canvas_height*.4, canvas_width*.4, 0, Math.PI);
			ctx.stroke();

			// Draw player circles
			function draw_player_circles(centerX, centerY, radius, size) {
				var angle = (2 * Math.PI) / 12; // Angle in radians
				for (var c = 1; c < 6; c++) {
					var x = centerX + radius * Math.cos(angle * c);
					var y = centerY + radius * Math.sin(angle * c);
					ctx.beginPath();
					ctx.arc(x, y, size, 0, 2*Math.PI);
					ctx.stroke();	
				}
			}
			draw_player_circles(canvas_bounds.left + canvas_width*.5, canvas_bounds.top + canvas_height*.4, canvas_width*.3, canvas_width*.05);

			// Deal Button
			ctx.rect(canvas_bounds.left+50, canvas_bounds.bottom-100,100,50);
			ctx.font = "20px Courier New";
            ctx.strokeStyle = "black";
			ctx.fillText("Deal", canvas_bounds.left+75, canvas_bounds.bottom-75);
			ctx.stroke();

			// Hit Button
			ctx.rect(canvas_bounds.left+550, canvas_bounds.bottom-175,100,50);
			ctx.fillText("Hit", canvas_bounds.left+575, canvas_bounds.bottom-150);
			ctx.stroke();
			
			// Stand Button
			ctx.rect(canvas_bounds.left+550, canvas_bounds.bottom-100,100,50);
			ctx.fillText("Stand", canvas_bounds.left+575, canvas_bounds.bottom-75);
			ctx.stroke();


			function display_hand(player, x, y) {
				// Display the hand of a given player at x,y location
				var hand = "";
				var total = player.hand_total;
				if (player.is_dealer && Game.state === State.playing_hand) {
					var c = 1;
					hand += "? "
				} else {
					var c = 0;
				}
				for (c; c < player.hand.length; c++) {
					hand += player.hand[c].rank;
					hand += " ";
				}
				ctx.fillText("Hand: " + hand, canvas_bounds.left + x, canvas_bounds.bottom - y);
				if (!player.is_dealer || Game.state !== State.playing_hand) {
					ctx.fillText("Total: " + total, canvas_bounds.left + x, canvas_bounds.bottom - y + 25);
				}
			}

			display_hand(human_player, 300, 75); // player could have a display hand method, if this approach remains
			display_hand(dealer_player, 300, 700);

			// Display message
			ctx.font = "22px Courier New";
            ctx.strokeStyle = "black";
			ctx.fillText(Game.message, canvas_bounds.left+250, canvas_bounds.bottom-500);
			ctx.stroke();
		}

		window.onload = function() {
			init();
			var mainloop_updateLast = performance.now();
			(function mainLoop(nowTime) {
				update(nowTime - mainloop_updateLast);
				display();
				mainloop_updateLast = nowTime;
				requestAnimationFrame(mainLoop);
			})(performance.now());
		}
	</script>
</body>
</html>