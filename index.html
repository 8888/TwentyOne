<html>
<head><title>Canvas Initial</title></head>
<body bgcolor="#24AF69">
	<canvas id="canvasElement" width="720" height="720" style="background-color: #F0F8FF;"></canvas>
	<script type="text/javascript">
		'use strict';
		var canvas = document.getElementById("canvasElement");
		canvas.tabIndex = 0;
		canvas.focus();

		var canvas_width = canvas.width;
		var canvas_height = canvas.height;
		var canvas_bounds = canvas.getBoundingClientRect();
		var ctx = canvas.getContext("2d");

        var mouseX = null,
            mouseY = null,
            toggle = false;

		var deck = null;
		var muck = []; // Discard pile
		var dealer = null; // Object that handles object interactions
		var human_player = null;
		var dealer_player = null;
		var players = []; // Array of all players in the game

		// Game initialization
		function init() {
			class Card {
				constructor(rank, value, suit) {
					this.rank = rank;
					this.value = value;
					this.suit = suit;
				}
			}

			class Player {
				constructor() {
					this.hand = [];
					this.hand_total = 0;
				}

				receive_card(card) {
					// add a card to the hand
					this.hand.push(card);
				}

				muck_hand() {
					// remove all cards from the hand
					return this.hand.splice(0, this.hand.length);
				}
			}

			var card_dealer_singleton = (function() {
				// Creates one and only one instance of the card dealer object
				var instance;
				function createInstance() {
					let dealer = new Object();
					// Dealer functions			
					dealer.rng = function(min, max) {
						// Returns a random integer between min(inclusive) and max(exclusive)
						return Math.floor(Math.random() * (max - min)) + min;
					}

					dealer.shuffle = function(unshuffled_deck, iterations = 10) {
						// Takes an array of Card objects and returns it in a random order
						var unshuffled_deck = unshuffled_deck;
						var shuffled_deck = [];
						for (var i = 0; i < iterations; i++) {
							for (var c = 0; c < unshuffled_deck.length;) {
								var index = dealer.rng(0, unshuffled_deck.length);
								var card = unshuffled_deck.splice(index, 1);
								shuffled_deck.push(card[0]);
							}
						}
						return shuffled_deck;
					}

					dealer.deal = function(deck, player) {
						// Deals the last card in the deck array to the player
						let card = deck.pop();
						player.receive_card(card);
					}

					dealer.muck_hands = function(player) {
						// Moves all of the cards from the player's hands to the muck pile
						var mucked_hand = player.muck_hand();
							for (var c = 0; c < mucked_hand.length;) {
								let card = mucked_hand.pop()
								muck.push(card);
							}

					}

					dealer.new_hand = function(players) {
						// Starts a new hand
						for (var c = 0; c < 2; c++){ // 2 cards total per player
							for (var p = 0; p < players.length; p++) { // alternates to each player
								dealer.deal(deck, players[p]);
							}
						}
					}

					return dealer;
				}
				return {
					getInstance: function() {
						if (!instance) {
							instance = createInstance();
						}
						return instance;
					}
 				}
			})();

			var card_ranks = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
			var card_values = [2,3,4,5,6,7,8,9,10,10,10,10,11]; // TODO: Does not account for Ace low
			var card_suits = ["Clubs", "Diamonds", "Hearts", "Spades"];

			function make_deck(decks = 1) {
				// Creates a usable deck of cards, comprised of a user chosen amount of standard 52 card decks
				var new_deck = [];
				for (var i = 0; i < decks; i++) { // Number of decks requested
					for (var r = 0; r < card_ranks.length; r++) { // Each rank of cards
						for (var s = 0; s < card_suits.length; s++) { // 1 card for each of the four suits
							new_deck.push(new Card(card_ranks[r], card_values[r], card_suits[s]));
						}
					}
				}
				return new_deck;
			}

			dealer = card_dealer_singleton.getInstance();
			human_player = new Player();
			dealer_player = new Player();
			players.push(human_player, dealer_player);
			deck = make_deck();
			deck = dealer.shuffle(deck);
		}

		//Handle User Input
		canvas.addEventListener("mousedown", function(event) {
			toggle = !toggle;

			// Click deal button
			mouseX = event.clientX - canvas_bounds.left;
			mouseY = event.clientY - canvas_bounds.top;
			if (mouseX > canvas_bounds.left+50 && mouseX < canvas_bounds.left+50+100) { // the buttons being clicked should have callable sizes, not hard coded all over the place. Variable? Object?
				if (mouseY > canvas_bounds.bottom-100 && mouseY < canvas_bounds.bottom-100+50) {
					for (var p = 0; p < players.length; p ++) { 
						if (players[p].hand) { // If the player has cards, discard them before dealing a new hand
							dealer.muck_hands(players[p]);
						}
					}
					dealer.new_hand(players);

					console.log(deck);
					console.log(human_player.hand);
					console.log(dealer_player.hand);
				}
			}
		});

		canvas.addEventListener("mousemove", function(event) {
			mouseX = event.clientX - canvas_bounds.left;
			mouseY = event.clientY - canvas_bounds.top;
		});

		var gameDelta = null,
            frameCount = 0;
		function update(delta) {
			gameDelta = delta;
            frameCount++;
		}

		function display() {
			ctx.clearRect(0, 0, canvas_width, canvas_height);
            ctx.font = "14px Courier New";
            ctx.strokeStyle = "black";
            let text = gameDelta.toFixed(2).toString() + "ms @ " + (1000/gameDelta).toFixed(2).toString() + "fps";
            if (toggle) {
                text = frameCount.toString() + " total frames";
            }

            ctx.strokeText(text, mouseX + 25, mouseY);


			// Draw initial basic interface
			// ****This will change as the game expands****

			// Deal Button
			ctx.rect(canvas_bounds.left+50, canvas_bounds.bottom-100,100,50);
			ctx.font = "20px Courier New";
            ctx.strokeStyle = "black";
			ctx.fillText("Deal", canvas_bounds.left+75, canvas_bounds.bottom-75);
			ctx.stroke();


			function display_hand(player, x, y) {
				// Display the hand of a given player at x,y location
				var hand = "";
				for (var c = 0; c < player.hand.length; c++) {
					hand += player.hand[c].rank;
					hand += " ";
				}
				ctx.fillText("Hand: " + hand, canvas_bounds.left + x, canvas_bounds.bottom - y);
			}

			display_hand(human_player, 200, 75); // player could have a display hand method, if this approach remains
			display_hand(dealer_player, 200, 700);
		}

		window.onload = function() {
			init();
			var mainloop_updateLast = performance.now();
			(function mainLoop(nowTime) {
				update(nowTime - mainloop_updateLast);
				display();
				mainloop_updateLast = nowTime;
				requestAnimationFrame(mainLoop);
			})(performance.now());
		}
	</script>
</body>
</html>